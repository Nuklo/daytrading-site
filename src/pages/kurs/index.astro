---
import Base from "../../layouts/Base.astro";
import { COURSES } from "../../data/courses";

const groups = ["Beginner", "Fortgeschritten", "Pro"] as const;
const byLevel = (lvl: typeof groups[number]) => COURSES.filter(c => c.level === lvl);
---

<Base title="Kurse" description="Lerne Trading Schritt für Schritt – vom Anfänger bis zum Pro.">
  <h1 class="text-2xl sm:text-3xl font-bold">Kurse</h1>
  <p class="opacity-80 mt-1">Lies die Folien, klick dich durch und bestehe den Test. Dein Fortschritt wird lokal gespeichert.</p>

  {groups.map((lvl) => (
    <section class="mt-6">
      <h2 class="text-xl font-semibold">{lvl}</h2>
      <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {byLevel(lvl).map(c => (
          <article class="card">
            <div class="flex items-start justify-between gap-2">
              <div>
                <h3 class="text-lg font-semibold">{c.title}</h3>
                <p class="text-sm opacity-80">{c.description}</p>
                <p class="text-xs opacity-60 mt-1">~ {c.minutes} Min</p>
              </div>
              <a href={`/kurs/${c.id}/`} class="btn-primary whitespace-nowrap">Start</a>
            </div>

            <div class="mt-4">
              <div class="h-2 w-full rounded bg-neutral-200 dark:bg-neutral-700 overflow-hidden">
                <div class="h-2 bg-primary transition-all" style={`width:0%`} data-bar={c.id}></div>
              </div>
              <div class="mt-2 text-xs opacity-80 flex items-center gap-2">
                <span data-pct={c.id}>0%</span>
                <span class="ml-auto flex items-center gap-1" data-badge={c.id}>
                  <!-- Bestanden-Badge wird per JS ersetzt -->
                </span>
              </div>
            </div>
          </article>
        ))}
      </div>
    </section>
  ))}

  <script is:inline define:vars={{ COURSES }}>
    const key = (id) => `course:${id}`;
    const bars = document.querySelectorAll("[data-bar]");
    const pcts = document.querySelectorAll("[data-pct]");
    const badges = document.querySelectorAll("[data-badge]");

    function load(id){
      try{ return JSON.parse(localStorage.getItem(key(id)) || "{}"); }catch{ return {}; }
    }

    COURSES.forEach(c => {
      const state = load(c.id);
      const total = c.slides.length;
      const seen = Math.min(state.slideIndex ?? 0, total);
      const passed = !!state.passed;
      const pct = Math.round(Math.max(seen/total, passed ? 1 : 0) * 100);

      const bar = document.querySelector(`[data-bar="${c.id}"]`);
      const pctEl = document.querySelector(`[data-pct="${c.id}"]`);
      const badge = document.querySelector(`[data-badge="${c.id}"]`);
      if (bar) bar.style.width = pct + "%";
      if (pctEl) pctEl.textContent = pct + "%";
      if (badge){
        badge.innerHTML = passed
          ? '<span class="text-green-600 dark:text-green-400">✔ Bestanden</span>'
          : '<span class="opacity-60">Nicht bestanden</span>';
      }
    });
  </script>
</Base>
